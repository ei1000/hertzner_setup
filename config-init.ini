#cloud-config
timezone: Europe/Oslo
package_update: true
package_upgrade: true

users:
  - name: deploy
    groups: [sudo]            # don't pre-reference docker; add it after install
    shell: /bin/bash
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    ssh_authorized_keys:
      - ssh-rsa AAAA...YOUR_PUBLIC_KEY... user@host

write_files:
  - path: /root/postinstall.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euxo pipefail

      apt-get update
      apt-get install -y ca-certificates curl gnupg lsb-release ufw unattended-upgrades

      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg

      ARCH="$(dpkg --print-architecture)"
      CODENAME="$(. /etc/os-release && echo "$VERSION_CODENAME")"
      echo "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${CODENAME} stable" \
        > /etc/apt/sources.list.d/docker.list

      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      # now the docker group exists
      usermod -aG docker root || true
      usermod -aG docker deploy || true
      systemctl enable --now docker

      ufw default deny incoming
      ufw default allow outgoing
      ufw allow 22/tcp
      ufw allow 80/tcp
      ufw allow 443/tcp
      # Optional app CIDRs:
      # ufw allow from 203.0.113.0/24 to any port 25565 proto tcp
      # ufw allow from 198.51.100.0/24 to any port 25565 proto tcp
      ufw --force enable

      dpkg-reconfigure -f noninteractive unattended-upgrades

      mkdir -p /opt/stack/{caddy,backups,mc-data}
      chown -R deploy:deploy /opt/stack

runcmd:
  - [ bash, /root/postinstall.sh ]
